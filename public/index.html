<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitView Kids</title>
    <link rel="icon" type="image/x-icon" href="assets/logo1.ico">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* [Existing Styles Kept for Brevity] */
        :root { --ytk-blue: #4285F4; --ytk-red: #D32F2F; --bg-light: #FAFAFA; }
        body { font-family: 'Fredoka', sans-serif; background: var(--bg-light); margin: 0; }
        header { display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .avatar { width: 45px; height: 45px; background: #CCC; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; color: white; font-weight: bold; }
        .owner-badge { position: absolute; bottom: -5px; right: -5px; background: gold; border: 2px solid white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: none; align-items: center; justify-content: center; color: black; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 20px; }
        .video-card { background: white; padding: 15px; border-radius: 25px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
        .video-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; background: black; aspect-ratio: 16/9; cursor: pointer; }
        video { width: 100%; height: 100%; display: block; }
        .btn { padding: 10px 22px; border-radius: 50px; font-weight: 600; cursor: pointer; border: none; font-family: 'Fredoka'; }
        .btn-red { background: var(--ytk-red); color: white; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 35px; border-radius: 30px; text-align: center; width: 320px; }
        .nav { display: flex; justify-content: center; gap: 40px; margin: 25px 0; }
        .nav-item { opacity: 0.5; cursor: pointer; font-weight: 600; }
        .nav-item.active { opacity: 1; color: var(--ytk-red); }
    </style>
</head>
<body>

    <div id="entry-screen">
        <div class="entry-content" style="text-align:center;">
            <h1 style="color: var(--ytk-blue);">BitView Kids</h1>
            <button class="btn btn-red" onclick="enterSite()">Let's Play!</button>
        </div>
    </div>

    <header>
        <div class="left" style="display:flex; align-items:center; gap:10px;">
            <div class="avatar" id="userAvatar">
                <span id="avatarLetter">üë§</span>
                <img id="avatarImg" src="assets/logo1.ico" style="width:100%; height:100%; border-radius:50%; display:none;">
                <div id="badge" class="owner-badge">üëë</div>
            </div>
            <div id="owner-stats" style="display:none;">
                <span style="font-size:12px; font-weight:bold;"><span id="real-subs">0</span> Subs</span>
            </div>
        </div>
        <div id="guest-zone"><button class="btn" onclick="openModal('login')">Login</button></div>
        <div id="user-zone" style="display:none; gap:10px;">
            <button class="btn btn-red" onclick="document.getElementById('fileInput').click()">Upload</button>
            <button class="btn" onclick="doLogout()">Logout</button>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-item active" id="nav-h" onclick="showHome()">üçø Shows</div>
        <div class="nav-item" id="nav-c" style="display:none;" onclick="showChannel()">üè† My Channel</div>
    </nav>

    <main id="home-pg">
        <div style="text-align:center;">
            <button id="sub-btn" class="btn" style="background:#333; color:white;" onclick="addSubscriber()">Subscribe to BitViewKidsOfficial</button>
        </div>
        <div class="video-grid" id="trendingGrid"></div>
    </main>

    <div id="chan-pg" style="display:none;"><div class="video-grid" id="videoGrid"></div></div>

    <div id="login-modal" class="modal">
        <div class="modal-box">
            <input type="text" id="l-user" placeholder="Your Name" style="width:80%; padding:10px; margin-bottom:10px;">
            <button class="btn btn-red" onclick="login()">Enter</button>
        </div>
    </div>

    <input type="file" id="fileInput" accept="video/*" style="display: none;" onchange="startUpload()">

    <script>
        let currentUser = localStorage.getItem('bitview_user') || null;
        let subs = parseInt(localStorage.getItem('bitview_subs')) || 0;

        function enterSite() {
            document.getElementById('entry-screen').style.display = 'none';
            // Ensure videos are loaded when entering
            loadVideos();
        }

        function login() {
            const user = document.getElementById('l-user').value;
            if (user) {
                currentUser = user;
                localStorage.setItem('bitview_user', user);
                setUI(user);
                closeModals();
            }
        }

        function setUI(user) {
            document.getElementById('guest-zone').style.display = 'none';
            document.getElementById('user-zone').style.display = 'flex';
            document.getElementById('nav-c').style.display = 'block';
            
            const isOwner = user.toLowerCase() === "bitviewkidsofficial";
            
            if (isOwner) {
                document.getElementById('avatarLetter').style.display = 'none';
                document.getElementById('avatarImg').style.display = 'block';
                document.getElementById('badge').style.display = 'flex';
                document.getElementById('owner-stats').style.display = 'block';
                document.getElementById('real-subs').innerText = subs;
                // SELF-SUB PREVENTION: Hide button if user is the owner
                document.getElementById('sub-btn').style.display = 'none';
            } else {
                document.getElementById('avatarLetter').innerText = user[0].toUpperCase();
                document.getElementById('sub-btn').style.display = 'inline-block';
            }
        }

        async function loadVideos() {
            try {
                const res = await fetch('/api/videos');
                const videos = await res.json();
                renderGrid(videos, 'trendingGrid', false);
            } catch (e) {
                console.log("Server not running yet");
            }
        }

        function renderGrid(videos, elementId, isOwnerView) {
            const grid = document.getElementById(elementId);
            grid.innerHTML = "";
            videos.forEach(file => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.innerHTML = `
                    <div class="video-container">
                        <video src="/assets/videos/${file}#t=0.5" controls></video>
                    </div>
                    <p><strong>${file}</strong></p>
                    ${isOwnerView ? `<button class="btn" style="color:red" onclick="deleteVideo('${file}')">Delete</button>` : ''}
                `;
                grid.appendChild(card);
            });
        }

        async function startUpload() {
            const file = document.getElementById('fileInput').files[0];
            const fd = new FormData();
            fd.append('video', file);
            await fetch('/api/upload', { method: 'POST', body: fd });
            loadVideos();
            if(document.getElementById('chan-pg').style.display === 'block') showChannel();
        }

        async function deleteVideo(name) {
            if(confirm("Delete this video?")) {
                await fetch(`/api/videos/${name}`, { method: 'DELETE' });
                showChannel();
            }
        }

        function showChannel() {
            document.getElementById('home-pg').style.display = 'none';
            document.getElementById('chan-pg').style.display = 'block';
            loadVideos().then(() => {
                 // Re-render specifically for channel view if needed, 
                 // here we just reuse the fetch but might need specific logic
                 // for simplicity, we reload grid. 
                 fetch('/api/videos').then(r=>r.json()).then(v => renderGrid(v, 'videoGrid', true));
            });
        }

        function showHome() {
            document.getElementById('home-pg').style.display = 'block';
            document.getElementById('chan-pg').style.display = 'none';
            loadVideos();
        }

        function addSubscriber() {
            // CONSTRAINT: Double check logic just in case
            if(currentUser && currentUser.toLowerCase() === "bitviewkidsofficial") {
                alert("You cannot subscribe to your own channel!");
                return;
            }
            subs++;
            localStorage.setItem('bitview_subs', subs);
            alert("Subscribed!");
        }

        function openModal(id) { document.getElementById(id + '-modal').style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function doLogout() { localStorage.clear(); location.reload(); }

        // AUTO-INIT: Restore session if exists
        if(currentUser) setUI(currentUser);
        
        // AUTO-LOAD: Fetch videos immediately so refresh works
        window.onload = loadVideos;
    </script>
</body>
</html>
